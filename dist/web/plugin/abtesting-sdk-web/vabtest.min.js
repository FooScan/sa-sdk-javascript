!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e}).apply(this,arguments)}var t,i,n=function(){function e(){var e=this;this.eventPool=new Map,this.on=function(t,i){var n=e.eventPool,s=n.get(t);s?n.set(t,[].concat(s,[i])):n.set(t,[i])},this.remove=function(t,i){var n=e.eventPool,s=n.get(t);if(s)return i?n.set(t,s.filter(function(e){return i!==e})):n["delete"](t)}}var t=e.prototype;return t.emit=function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];var s=this.eventPool.get(e);s&&s.forEach(function(e){e.apply(void 0,i)})},t.get=function(){var e;return(e=this.eventPool).get.apply(e,arguments)},t.has=function(){var e;return(e=this.eventPool).has.apply(e,arguments)},t["delete"]=function(){var e;return(e=this.eventPool)["delete"].apply(e,arguments)},t.forEach=function(){var e;return(e=this.eventPool).forEach.apply(e,arguments)},t.keys=function(){return this.eventPool.keys()},t.set=function(){var e;return(e=this.eventPool).set.apply(e,arguments)},e}();!function(e){e[e.connect=0]="connect",e[e.dispose=1]="dispose"}(t||(t={})),function(e){e.SUCCESS="SUCCESS",e.PENDING="PENDING",e.ERROR="ERROR",e.TIMEOUT="TIMEOUT"}(i||(i={}));var s,o,r,a,l,d,c=(s=(new Date).getTime(),function(e){return Math.ceil((s=(9301*s+49297)%233280)/233280*e)}),u=function(e,t){return function(){if("function"==typeof Uint32Array){var e=null;if("undefined"!=typeof crypto?e=crypto:"undefined"!=typeof window.msCrypto&&(e=window.msCrypto),"object"==typeof e&&e.getRandomValues){var t=new Uint32Array(1);return e.getRandomValues(t)[0]/Math.pow(2,32)}}return c(1e19)/1e19}()*(t-e)+e},h=function(){function t(s){var o=this;this.iframe=void 0,this.ENV="IFRAME",this.config={source:"",frameSource:""},this.context=void 0,this.messagePool=new n,this.receiveMessageHandle=function(n){var s=t.MessageDecode(null==n?void 0:n.data);if(o.config.debug&&console.log("[@FrameBridge:"+o.ENV+" receiveMessage type:"+(null==s?void 0:s.type)+" id:"+(null==s?void 0:s.$id)+" ]=>",s),null!=s&&s.$id){var r=s.$id,a=void 0===r?"":r,l=s.type,d=void 0===l?"":l;if(s.source===o.config.frameSource){var c=o.messagePool.has(a),u=o.messagePool.has(d);c&&o.messagePool.emit(a,{status:i.SUCCESS,payload:s}),u&&o.messagePool.emit(d,e({},s,{status:i.SUCCESS}))}}},this.iframeLoadHandle=function(){var e;(null==(e=o.iframe)?void 0:e.contentWindow)&&console.log("load success")},this.config=s,this.init()}t.MessageEncode=function(e,t){void 0===e&&(e={}),void 0===t&&(t=JSON.stringify({}));var i=t;try{i=encodeURIComponent(JSON.stringify(e))}catch(n){console.error("[@FrameBridge:error] MessageDecode error",n)}return i},t.MessageDecode=function(e,t){void 0===t&&(t=null);var i=t;try{i=JSON.parse(decodeURIComponent(e||""))}catch(n){i=t,console.warn("@FrameBridge MessageDecode error",n)}return i};var s=t.prototype;return s.emit=function(e,n,s){var o,r,a=this,l=(s||{}).timeout,d=void 0===l?51e3:l,c=this.config.source,h=function(e){return void 0===e&&(e=""),e+"@"+Date.now()+"@"+u(0,10)}(this.ENV),m={$id:h,type:e,status:i.PENDING,payload:n,source:c};"IFRAME"===this.ENV?this.context=null==(o=window)?void 0:o.parent:this.context=null==(r=this.iframe)?void 0:r.contentWindow;return this.context?new Promise(function(e){var n,s;a.messagePool.on(h,function(t){e(t),a.messagePool.remove(h)}),d&&setTimeout(function(){a.messagePool.has(h)&&a.messagePool.emit(h,{status:i.TIMEOUT})},d),a.config.debug&&console.log("[@FrameBridge:"+a.ENV+" emit] => ",m),null==(n=a.context)||n.postMessage(t.MessageEncode(m),(null==(s=a.config)?void 0:s.origin)||"*")}):Promise.resolve({status:i.ERROR,message:"No communication environment,Please check config!"})},s.on=function(e,t){var i=this;this.messagePool.on(e,function(e){var n=e.$id;return t({reply:function(e){i.emit(n,e)}},e,i.config)})},s.destroy=function(){var e;window.removeEventListener("message",this.receiveMessageHandle),null==this||null==(e=this.iframe)||null==e.removeEventListener||e.removeEventListener("load",this.iframeLoadHandle)},s.init=function(){var e,t=this.config.container;if(t){this.ENV="CONTAINER";var i="string"===((e=t)===undefined?"undefined":null===e?"null":e.constructor.name.toLowerCase())?document.querySelector(t):t;if(this.iframe=i,!(i&&i instanceof HTMLIFrameElement))return console.error("[@FrameBridge:error]container is not IFRAME element!"),this;i.addEventListener("load",this.iframeLoadHandle)}else this.ENV="IFRAME";window.addEventListener("message",this.receiveMessageHandle,!1)},t}();!function(e){e.address="address",e.article="article",e.aside="aside",e.footer="footer",e.header="header",e.h1="h1",e.h2="h2",e.h3="h3",e.h4="h4",e.h5="h5",e.h6="h6",e.main="main",e.nav="nav",e.section="section",e.blockquote="blockquote",e.dd="dd",e.div="div",e.dl="dl",e.dt="dt",e.figcaption="figcaption",e.figure="figure",e.hr="hr",e.li="li",e.ol="ol",e.p="p",e.pre="pre",e.ul="ul",e.a="a",e.abbr="abbr",e.b="b",e.bdi="bdi",e.bdo="bdo",e.br="br",e.cite="cite",e.code="code",e.data="data",e.dfn="dfn",e.em="em",e.i="i",e.kbd="kbd",e.mark="mark",e.q="q",e.rp="rp",e.rt="rt",e.ruby="ruby",e.s="s",e.samp="samp",e.small="small",e.span="span",e.strong="strong",e.sub="sub",e.sup="sup",e.time="time",e.u="u",e["var"]="var",e.wbr="wbr",e.img="img",e.area="area",e.audio="audio",e.base="base",e.body="body",e.button="button",e.canvas="canvas",e.caption="caption",e.col="col",e.colgroup="colgroup",e.datalist="datalist",e.del="del",e.details="details",e.dialog="dialog",e.embed="embed",e.fieldset="fieldset",e.form="form",e.head="head",e.hgroup="hgroup",e.html="html",e.iframe="iframe",e.input="input",e.ins="ins",e.label="label",e.legend="legend",e.link="link",e.map="map",e.math="math",e.menu="menu",e.menuitem="menuitem",e.meta="meta",e.meter="meter",e.noscript="noscript",e.object="object",e.optgroup="optgroup",e.option="option",e.output="output",e.param="param",e.picture="picture",e.progress="progress",e.rb="rb",e.rtc="rtc",e.script="script",e.select="select",e.slot="slot",e.source="source",e.style="style",e.summary="summary",e.svg="svg",e.table="table",e.tbody="tbody",e.td="td",e.template="template",e.textarea="textarea",e.tfoot="tfoot",e.th="th",e.thead="thead",e.title="title",e.tr="tr",e.track="track",e.video="video"}(r||(r={})),function(e){e.connect="CONNECT",e.dispose="DISPOSE",e.setDevice="SET_DEVICE",e.setMode="SET_MODE",e.markElement="MARK_ELEMENT",e.cancelMarkElement="CANCEL_MARK_ELEMENT",e.selectElement="SELECT_ELEMENT",e.cancelSelectElement="CANCEL_SELECT_ELEMENT",e.addElementSnapshot="ADD_ELEMENT_SNAPSHOT",e.resetElementSnapshot="RESET_ELEMENT_SNAPSHOT",e.deleteElementSnapshot="DELETE_ELEMENT_SNAPSHOT",e.updateElementSnapshot="UPDATE_ELEMENT_SNAPSHOT",e.getElementSnapshot="GET_ELEMENT_SNAPSHOT",e.keydownEvent="KEY_DOWN",e.mouseupEvent="MOUSE_UP",e.mousemoveEvent="MOUSE_MOVE",e.wheelEvent="WHEEL_EVENT",e.getHtml="GET_HTML",e.checkUrl="CHECK_URL",e.insertionInfo="INSERTION_INFO"}(a||(a={})),function(e){e.CHANGE="CHANGE",e.INSERTION="INSERTION",e.BEFORE_INSERTION="BEFORE_INSERTION",e.AFTER_INSERTION="AFTER_INSERTION"}(l||(l={})),function(e){e.VIEW="VIEW",e.EDIT="EDIT"}(d||(d={}));r.img,r.a,r.h1,r.h2,r.h3,r.h4,r.h5,r.h6,r.span,r.div,r.li,r.ol,r.p,r.pre,r.ul,r.dd,r.i,r.dt,r.dl,r.b,r.cite,r.em,r.mark,r.small,r.strong,r.sub,r.sup,r.u,r.button,r.td,r.title,r.label,r.code,r.blockquote,r.figcaption,r.figure,r.area,r.select,r.article,r.slot,r.aside;(o={})[a.keydownEvent]={eventValues:["key","keyCode","ctrlKey","metaKey"],preventDefault:!0},o[a.mouseupEvent]={eventValues:[]},o[a.wheelEvent]={eventValues:["ctrlKey","metaKey","deltaY"],preventDefault:!0},o[a.mousemoveEvent]={eventValues:["clientX","clientY"]};var m={};function f(e){this.SensorsABTest=e}function p(e){this.attr_name="sa-abtest-"+e,this.remove_timer=null,this.is_added=!1,this.is_abort=!1,this.is_timeout=!1,this.style_element=null,this.createMaskStyle()}function v(e,t){if(!e||!e.parentNode||!e.parentNode.children)return!1;t=t&&t.join?t:[];var i=e.nodeName.toLowerCase();return e&&"body"!==i&&1==e.nodeType?(t.unshift(function(e){var t=e.parentNode&&9==e.parentNode.nodeType?-1:function(e){if(!e.parentNode)return-1;for(var t=0,i=e.tagName,n=e.parentNode.children,s=0;s<n.length;s++)if(n[s].tagName===i){if(e===n[s])return t;t++}return-1}(e);return e.getAttribute&&e.getAttribute("id")&&/^[A-Za-z][-A-Za-z0-9_:.]*$/.test(e.getAttribute("id"))?"#"+e.getAttribute("id"):e.tagName.toLowerCase()+(~t?":nth-of-type("+(t+1)+")":"")}(e)),e.getAttribute&&e.getAttribute("id")&&/^[A-Za-z][-A-Za-z0-9_:.]*$/.test(e.getAttribute("id"))?t.join(" > "):v(e.parentNode,t)):(t.unshift("body"),t.join(" > "))}function g(e){var t=e.getBoundingClientRect(),i=t.top+(document.body.scrollTop||document.documentElement.scrollTop),n=t.left+(document.body.scrollLeft||document.documentElement.scrollLeft),s=m.ry(e).getStyle("z-index")||0;return{width:t.width,height:t.height,top:i,left:n,zIndex:s}}function E(e){var t=e.childNodes,i="",n=!1;return m.each(t,function(e){if(!1===n&&3===e.nodeType){var t=e.textContent||e.innerText||e.nodeValue||"";t&&(i=m.trim(t),n=!0)}}),i}function y(e,t){var i=e.tagName;E(e)!==t&&(e.textContent?e.textContent=t:e.innerText?e.innerText=t:e.innerHTML=t,"input"!==i&&"INPUT"!==i||(e.value=t||""))}function b(e,t,i){e.setAttribute(t,i)}function _(e,t,i){i||(i=function(e,t){var i=t.originProps,n={attributes:{}},s=i.attributes;return m.each(s.style||{},function(t,i){n.attributes.style[i]=m.ry(e).getStyle(i)}),Object.hasOwnProperty.call(i,"text")&&(n.attributes.text=E(e)),m.each(["src","href"],function(t){Object.hasOwnProperty.call(s,t)&&(n.attributes[t]=e[t])}),Object.hasOwnProperty.call(s,"target")&&(n.attributes.target=e.getAttribute("target")),n}(e,t));var n=function(e,t){var i=e.originProps,n=t.originProps,s=i.attributes,o=n.attributes,r=!0;return i.text&&i.text!==n.text&&(r=!1),s&&m.each(["src","href","target"],function(e){s[e]&&s[e]!==o[e]&&(r=!1)}),r}(t,i);if(n){var s=t.props;m.isObject(s)&&function(e,t,i){if(Object.hasOwnProperty.call(t,"attributes")){var n=t.attributes;Object.hasOwnProperty.call(n,"style")&&function(e,t,i){var n=m.getUA(),s=n.ie&&n.ie<9,o="";m.each(t,function(e,t){var i;s&&e.indexOf("rgba")>-1&&(e=(i=e.match(/[\d.]+/g)).length>=3?"rgb("+i[0]+","+i[1]+","+i[2]+")":"");var n=t.replace(/[A-Z]+/g,function(e){return"-"+e.toLowerCase()});o+=n+": "+e+" !important;"}),""!==o&&(S({attr_value:i=m.encodeSelector(i),text:o="[sensors_ab_ele_style_id="+i+"]{"+o+"}",attr_key:"sensors_ab_ele_style_id"}),e.setAttribute("sensors_ab_ele_style_id",i))}(e,n.style,i.selector),m.each(["href","target","src"],function(t){n[t]&&e.getAttribute(t)!==n[t]&&b(e,t,n[t])})}Object.hasOwnProperty.call(t,"text")&&y(e,t.text)}(e,s,t)}return n}function S(e){try{var t=document.createElement("style");t.innerHTML=e.text,t.setAttribute(e.attr_key,e.attr_value),document.getElementsByTagName("head")[0].append(t)}catch(i){window.sensorsABTestModifyListener&&window.sensorsABTestModifyListener(e,i.stack||i.message)}}function w(e){try{var t=document.createElement("script");t.setAttribute(e.attr_key,e.attr_value),t.innerHTML="try{"+e.text+"}catch(e){ window.sensorsABTestModifyListener && window.sensorsABTestModifyListener("+JSON.stringify(e)+", e.stack || e.message) }",document.body.append(t)}catch(i){window.sensorsABTestModifyListener&&window.sensorsABTestModifyListener(e,i.stack||i.message)}}function D(e){var t=e.getBoundingClientRect(),i=window.innerWidth?{w:window.innerWidth,h:window.innerHeight}:(document.compatMode="BackCompat")?{w:document.body.clientWidth,h:document.body.clientHeigth}:{w:document.documentElement.clientWidth,h:document.documentElement.clientHeight},n=document.documentElement.scrollTop||document.body.scrollTop,s=document.documentElement.scrollLeft||document.body.scrollLeft,o=t.width,r=t.height,a=t.left+i.w/2-o/2+s,l=t.top-i.h/2+r/2+n;window.scrollTo(a,l)}function N(e,t){var i=e.tagName.toLowerCase(),n=function(e,t){var i={};return m.each(t||[],function(t){var n=t.replace(/[A-Z]+/g,function(e){return"-"+e.toLowerCase()});i[t]=m.ry(e).getStyle(n)}),i}(e,t),s={selector:v(e),originProps:{attributes:{style:n},text:E(e)},type:"text",tagName:i};return"a"===i&&(s.originProps.attributes.href=e.href,e.getAttribute("target")&&(s.originProps.attributes.target=e.getAttribute("target")),s.type="link"),"img"===i&&(s.originProps.attributes.src=e.src,s.type="img"),{originStyle:e.getAttribute("style"),eleInfo:s,ele:e}}function T(e){var t=e.eleInfo,i=e.ele;if(i){var n=t.originProps;if(Object.hasOwnProperty.call(n,"attributes")){var s=n.attributes;O({attr_value:m.encodeSelector(t.selector),attr_key:"sensors_ab_ele_style_id",ele:i}),m.each(["href","target","src"],function(e){s[e]&&i.getAttribute(e)!==s[e]&&b(i,e,s[e])})}Object.hasOwnProperty.call(n,"text")&&y(i,n.text)}}function O(e){var t=e.attr_value,i=e.attr_key,n=e.ele,s=document.querySelectorAll("["+i+"]");s&&s.length&&m.each(s,function(e){var n=e.getAttribute(i);e.parentElement&&(t===n||!t)&&["style","script"].indexOf(e.tagName.toLowerCase())>-1&&e.parentElement.removeChild(e)}),n&&i&&n.removeAttribute(i)}function k(){if(!window.name)return!1;try{var e=JSON.parse(decodeURIComponent(window.name||"")),t=e.is_vabtesting,i=e.source_url,n=e.link_match_type;return!(!0!==t||!m.checkUrlIsMatch(i,n))||(m.log("A/B Testing SDK \u9875\u9762\u5730\u5740\uff0c\u4e0e\u5f53\u524d\u5b9e\u9a8c URL \u4e0d\u5339\u914d\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff01"),!1)}catch(s){return!1}}m.secCheck={isHttpUrl:function(e){if("string"!=typeof e)return!1;return!1!==/^https?:\/\/.+/.test(e)||(m.log("Invalid URL"),!1)},removeScriptProtocol:function(e){if("string"!=typeof e)return"";for(var t=/^\s*javascript/i;t.test(e);)e=e.replace(t,"");return e}},m.checkUrlIsMatch=function(e,t){var i,n,s=m.URL(e);if("STRICT"===t)return location.href===s.href;if("FUZZY"===t){try{i=m.URL(location.href)}catch(o){return m.log("url \u89e3\u6790\u5931\u8d25",o),!1}try{n=m.URL(e)}catch(o){return m.log("control_url \u89e3\u6790\u5931\u8d25",o),!1}return i.host===n.host&&i.pathname===n.pathname}return m.log("link_match_type\u5b57\u6bb5\u5f02\u5e38",t),!1},m.checkUrlIsRegexp=function(e,t){var i;try{i=m.URL(location.href)}catch(n){return m.log("url \u89e3\u6790\u5931\u8d25",n),!1}try{return!!(t?new RegExp(e,t):new RegExp(e)).exec(i.href)}catch(n){return m.log("control_link\u5b57\u6bb5\u5f02\u5e38",n),!1}},m.log=function(){if("object"==typeof console&&console.log){m.isString(arguments[0])&&(arguments[0]="sensorsabtest————"+arguments[0]);try{return console.log.apply(console,arguments)}catch(e){console.log(arguments[0])}}},m.error=function(){if("object"==typeof console&&console.error)try{return console.error.apply(console,arguments)}catch(e){console.error(arguments[0])}},m.encodeSelector=function(e){return m.base64Encode(e).replace(/[+\/=]/g,function(e){return"_"})},f.prototype={value_type_list:["Number","String","Object","Boolean"],regName:/^((?!^distinct_id$|^original_id$|^time$|^properties$|^id$|^first_id$|^second_id$|^users$|^events$|^event$|^user_id$|^date$|^datetime$|^user_tag.*|^user_group.*)[a-zA-Z_][a-zA-Z\d_]*)$/i,valueType:function(e,t){switch(t){case"Number":if(m.isNumber(e))return!0;break;case"String":if(m.isString(e))return!0;break;case"Object":if(m.isObject(e))return!0;break;case"Boolean":if(!0===e||!1===e)return!0;break;default:return!1}return!1},para:function(e,t,i){var n=this,s={verify_success:!0,para:null};return m.each(i,function(i,o){if("essential"===i)switch(o){case"param_name":m.isString(t.param_name)&&t.param_name.length>0||(n.SensorsABTest.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cparam_name\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e\uff01param_name:",t.param_name),s.verify_success=!1);break;case"value_type":m.isString(t.value_type)&&-1!==m.indexOf(n.value_type_list,t.value_type)||(n.SensorsABTest.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cvalue_type\u914d\u7f6e\u9519\u8bef",t.value_type),s.verify_success=!1);break;case"default_value":"undefined"==typeof t.default_value?(n.SensorsABTest.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u53c2\u6570\u672a\u914d\u7f6e"),s.verify_success=!1):n.valueType(t.default_value,t.value_type)||(n.SensorsABTest.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u7c7b\u578b\u5fc5\u987b\u4e0evalue_type\u4e00\u81f4\uff01",t.default_value,t.value_type),s.verify_success=!1);break;case"callback":m.isFunction(t.callback)||(n.SensorsABTest.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0ccallback\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),s.verify_success=!1);break;default:s.verify_success=!1}else if("not_essential"===i)switch(o){case"timeout_milliseconds":t.timeout_milliseconds=t.timeout_milliseconds||n.SensorsABTest.para.timeout_milliseconds||n.SensorsABTest.default_para.timeout_milliseconds,(!m.isNumber(t.timeout_milliseconds)||m.isNumber(t.timeout_milliseconds)&&t.timeout_milliseconds<=0)&&(n.SensorsABTest.log("timeout_milliseconds \u53c2\u6570\u9519\u8bef",t.timeout_milliseconds),t.timeout_milliseconds=n.SensorsABTest.para.timeout_milliseconds),t.timeout_milliseconds<200&&(t.timeout_milliseconds=200);break;case"properties":t.properties=m.isObject(t.properties)?t.properties:{}}}),s.para=t,s},resolveCustomProperties:function(e){var t=this,i={verify_success:!0,para:null},n=e.custom_properties;if(!m.isObject(n)||m.isEmptyObject(n))return delete e.custom_properties,i.para=e,i;if(m.each(n,function(e,n){if((!m.isString(n)||!t.regName.test(n)||n.length>100)&&(t.SensorsABTest.log(" property name [ "+n+" ] is not invalid "),i.verify_success=!1),(m.isString(e)||m.isNumber(e)||m.isBoolean(e)||m.isArray(e)||m.isDate(e))&&!(m.isString(e)&&e.length>500)||(t.SensorsABTest.log("property [ "+n+" ] of value [ "+JSON.stringify(e)+" ] is not invalid"),i.verify_success=!1),m.isArray(e)){var s=!0;m.each(e,function(e){!1!==s&&(m.isString(e)||(s=!1))}),s||(t.SensorsABTest.log("property  value type can be array, but only allow string item. property [ "+n+" ] of value  "+JSON.stringify(e)+"  is not invalid"),i.verify_success=!1)}}),!0===i.verify_success){var s={};m.each(n,function(e,t){m.isDate(e)?s[t]=m.formatDate(e):m.isString(e)?s[t]=e:s[t]=JSON.stringify(e)}),e.custom_properties=s}return i.para=e,i}},m.VerifyStore=f,m.listenPageState=function(e){({visibleHandle:m.isFunction(e.visible)?e.visible:function(){},hiddenHandler:m.isFunction(e.hidden)?e.hidden:function(){},visibilityChange:null,hidden:null,isSupport:function(){return"undefined"!=typeof document[this.hidden]},init:function(){"undefined"!=typeof document.hidden?(this.hidden="hidden",this.visibilityChange="visibilitychange"):"undefined"!=typeof document.mozHidden?(this.hidden="mozHidden",this.visibilityChange="mozvisibilitychange"):"undefined"!=typeof document.msHidden?(this.hidden="msHidden",this.visibilityChange="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(this.hidden="webkitHidden",this.visibilityChange="webkitvisibilitychange"),this.listen()},listen:function(){if(this.isSupport()){var e=this;document.addEventListener(e.visibilityChange,function(){document[e.hidden]?e.hiddenHandler():e.visibleHandle()},1)}else document.addEventListener?(window.addEventListener("focus",this.visibleHandle,1),window.addEventListener("blur",this.hiddenHandler,1)):(document.attachEvent("onfocusin",this.visibleHandle),document.attachEvent("onfocusout",this.hiddenHandler))}}).init()},m.listenPageState=function(e){({visibleHandle:m.isFunction(e.visible)?e.visible:function(){},hiddenHandler:m.isFunction(e.hidden)?e.hidden:function(){},visibilityChange:null,hidden:null,isSupport:function(){return"undefined"!=typeof document[this.hidden]},init:function(){"undefined"!=typeof document.hidden?(this.hidden="hidden",this.visibilityChange="visibilitychange"):"undefined"!=typeof document.mozHidden?(this.hidden="mozHidden",this.visibilityChange="mozvisibilitychange"):"undefined"!=typeof document.msHidden?(this.hidden="msHidden",this.visibilityChange="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(this.hidden="webkitHidden",this.visibilityChange="webkitvisibilitychange"),this.listen()},listen:function(){if(this.isSupport()){var e=this;document.addEventListener(e.visibilityChange,function(){document[e.hidden]?e.hiddenHandler():e.visibleHandle()},1)}else document.addEventListener?(window.addEventListener("focus",this.visibleHandle,1),window.addEventListener("blur",this.hiddenHandler,1)):(document.attachEvent("onfocusin",this.visibleHandle),document.attachEvent("onfocusout",this.hiddenHandler))}}).init()},m.getStorageData=function(e,t){var i=m.localStorage.get(e);m.isString(i)&&(i=t.kit.userDecryptIfNeeded(i));try{i=JSON.parse(i)}catch(n){m.log(n)}return i},m.setStorageData=function(e,t,i){e=JSON.stringify(e),i&&(e=m.userEncrypt(e)),m.localStorage.set(t,e)},p.prototype={createMaskStyle:function(){var e="["+this.attr_name+"],["+this.attr_name+"] body{opacity:0 !important;-khtml-opacity:0 !important;-moz-opacity:0;filter:alpha(opacity=0);}",t=document.createElement("style");t.type="text/css";try{t.appendChild(document.createTextNode(e))}catch(i){t.styleSheet.cssText=e}try{this.style_element=t,document.getElementsByTagName("head")[0].appendChild(t)}catch(i){m.log("error when create calls")}},show:function(e){try{var t=this;if(this.is_abort)return!1;var i=null;if(i=document.getElementsByTagName("html")[0],!m.isElement(i))return;i.setAttribute(this.attr_name,"1"),this.is_added=!0,m.isNumber(e)&&(this.remove_timer=setTimeout(function(){t.is_timeout=!0,t.remove()},e))}catch(n){m.log("error when show calls")}},remove:function(){try{if(this.is_abort||(this.is_abort=!0),this.is_added){this.is_added=!1;var e=null;if(e=document.getElementsByTagName("html")[0],!m.isElement(e))return;e.removeAttribute(this.attr_name),this.style_element&&(document.getElementsByTagName("head")[0].removeChild(this.style_element),this.style_element=null)}this.remove_timer&&(clearTimeout(this.remove_timer),this.remove_timer=null)}catch(t){m.log("error when remove calls")}}},m.Mask=p;class P{constructor(e){this.bridge=e.bridge,this.domEditor=e.domEditor;for(let e in a)m.isFunction(this[e])&&this.bridge.on(a[e],this[e].bind(this))}updateElementSnapshot(e,t){let i=t.payload;switch(i.type){case"img":case"link":case"text":let t=this.domEditor.getOriginDataBySelector(i.selector),o=t.ele;if(this.domEditor.updataServerData(i.selector,i),!o)return void e.reply({status:"ERROR",message:"\u8be5\u5143\u7d20\u672a\u5728\u5f53\u524d\u9875\u9762\u51fa\u73b0\uff01",code:"4001"});{T(t),this.domEditor.editEleProps(i,t);let e=g(o);this.domEditor.setSelectElePostion(e)}break;case"globalScript":var n={attr_value:i.id,text:i.props.text,attr_key:"sensors_ab_script_id"};O(n),w(n);break;case"globalStyle":var s={attr_value:i.id,text:i.props.text,attr_key:"sensors_ab_style_id"};O(s),S(s)}e.reply({status:"SUCCESS"})}setMode(e,t){let i=t.payload.type,n=!0;this.domEditor.setMode(i),k()||(n=!1,this.domEditor.mode_type="VIEW"),e.reply({status:"SUCCESS",check_url:n})}resetElementSnapshot(e,t){let i=this,n=t.payload,s=[];this.domEditor.saveServerData(n),this.domEditor.restoreElements(),m.each(n,function(e){let t=e.type,n=i.domEditor.getOriginDataBySelector(e.selector);if(n.ele)i.domEditor.editEleProps(e,n);else if("globalScript"===t){var o={attr_value:e.id,text:e.props.text,attr_key:"sensors_ab_script_id"};O(o),w(o)}else if("globalStyle"===t){var r={attr_value:e.id,text:e.props.text,attr_key:"sensors_ab_style_id"};O(r),S(r)}else s.push(e)}),this.domEditor.resetSelectDivPostion(),this.domEditor.resetHoverDivPostion(),e.reply({status:"SUCCESS",no_found_list:s})}markElement(e,t){let i=t.payload,n=this.domEditor.getOriginDataBySelector(i.selector).ele;if(n){let t=g(n);this.domEditor.setHoverElePostion(t),e.reply({status:"SUCCESS"})}else e.reply({status:"ERROR",message:"\u8be5\u5143\u7d20\u672a\u5728\u5f53\u524d\u9875\u9762\u51fa\u73b0\uff01",code:"4001"})}selectElement(e,t){let i=t.payload,n=this.domEditor.getOriginDataBySelector(i.selector).ele;if(n){let t=g(n);this.domEditor.setSelectElePostion(t),D(n),e.reply({status:"SUCCESS"})}else e.reply({status:"ERROR",message:"\u8be5\u5143\u7d20\u672a\u5728\u5f53\u524d\u9875\u9762\u51fa\u73b0\uff01",code:"4001"})}addElementSnapshot(e,t){this.updateElementSnapshot(e,t)}deleteElementSnapshot(e,t){this.updateElementSnapshot(e,t)}getHtml(e){let t=document.getElementsByTagName("html")[0].outerHTML;t=t.replace(/class="sa-vabtest-mark"/g,'class="sa-vabtest-mark-hidden"'),e.reply({status:"SUCCESS",visual_dom:t,origin_url:location.href,dom_width:Math.max(document.body.scrollWidth,document.body.offsetWidth,document.documentElement.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth),dom_height:Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight)})}cancelSelectElement(e){this.domEditor.resetSelectDivPostion(),e.reply({status:"SUCCESS"})}cancelMarkElement(e){this.domEditor.resetHoverDivPostion(),e.reply({status:"SUCCESS"})}checkUrl(e){let t=!0;k()||(t=!1,this.domEditor.mode_type="VIEW"),e.reply({status:t?"SUCCESS":"ERROR"})}}class M{constructor(e){this.bridge=e.bridge,this.domEditor=e.domEditor,this.tagNames=e.tagNames,this.sd=e.sd}init(e){this.config=e,this.addLisenter()}addLisenter(){let e=this.config.action;var t;e.KEY_DOWN&&m.addEvent(document.body,"keydown",this.keydownHandler.bind(this)),e.MOUSE_UP&&m.addEvent(document.body,"mouseup",this.mouseupHandler.bind(this)),e.WHEEL_EVENT&&m.addEvent(document.body,"wheel",this.wheelHandler.bind(this)),m.addEvent(document,"mousemove",this.moveHandler.bind(this)),m.addEvent(document,"click",this.clickHandler.bind(this),!0),this.sd.ee.spa.on("switch",this.singlePage.bind(this)),t=this.mutationObserver.bind(this),new(0,window.MutationObserver)(t).observe(document.body,{childList:!0,subtree:!0}),this.addInsertionErrorListener()}addInsertionErrorListener(){var e=this;window.sensorsABTestModifyListener=function(t,i){var n={type:t.type,id:t.id,isSuccess:!i};i&&(n.errorMessage=i),e.bridge.emit(a.insertionInfo,n)}}elementFilter(e){if(e){let t=e.tagName.toLowerCase();if(this.tagNames.indexOf(t)>-1){if("a"===t||"img"===t||"button"===t)return e;return this.domEditor.getOriginDataByElement(e).eleInfo.originProps.text?e:null}}return null}getMouseElement(e){let t=null;return m.each(e,function(e){!t&&m.isString(e.className)&&-1===e.className.indexOf("sa-vabtest-mark")&&(t=e)}),t}moveHandler(e){let t=this.config.action;if(t.MOUSE_MOVE&&t.MOUSE_MOVE&&t.MOUSE_MOVE.eventValues&&m.isArray(t.MOUSE_MOVE.eventValues)){let i={};m.each(t.MOUSE_MOVE.eventValues,function(t){i[t]=e[t]}),this.bridge.emit(a.mousemoveEvent,i)}if("EDIT"!==this.domEditor.mode_type)return;let i=document.elementsFromPoint(e.clientX,e.clientY),n=this.getMouseElement(i),s=this.elementFilter(n);if(s){let e=g(s);this.domEditor.setHoverElePostion(e)}else this.domEditor.resetHoverDivPostion()}clickHandler(e){if("EDIT"!==this.domEditor.mode_type)return;e.stopPropagation(),e.preventDefault();let t=document.elementsFromPoint(e.clientX,e.clientY),i=this.getMouseElement(t),n=this.elementFilter(i);if(n){let e=this.domEditor.getOriginDataByElement(n).eleInfo,t=e.selector,i=this.domEditor.getServerDataBySelector(t),s=m.extend(i||{isModify:!1},e),o=g(n);this.domEditor.setSelectElePostion(o),this.bridge.emit(a.selectElement,s)}else this.domEditor.resetSelectDivPostion(),this.bridge.emit(a.cancelSelectElement,{status:!0})}keydownHandler(e){let t={},i=this.config.action,n=(e.ctrlKey||e.metaKey?"cmd+":"")+e.key;"cmd+-"!==n&&"cmd+="!==n&&"Escape"!==n||(!0===i.KEY_DOWN.preventDefault&&e.preventDefault(),i.KEY_DOWN.eventValues&&m.isArray(i.KEY_DOWN.eventValues)&&m.each(i.KEY_DOWN.eventValues,function(i){t[i]=e[i]}),this.bridge.emit(a.keydownEvent,t))}mouseupHandler(e){let t={},i=this.config.action;i.MOUSE_UP&&(!0===i.MOUSE_UP.preventDefault&&e.preventDefault(),i.MOUSE_UP.eventValues&&m.isArray(i.MOUSE_UP.eventValues)&&m.each(i.MOUSE_UP.eventValues,function(i){t[i]=e[i]}),this.bridge.emit(a.mouseupEvent,t))}wheelHandler(e){let t={},i=this.config.action;i.WHEEL_EVENT&&(!0===i.WHEEL_EVENT.preventDefault&&e.preventDefault(),i.WHEEL_EVENT.eventValues&&m.isArray(i.WHEEL_EVENT.eventValues)&&m.each(i.WHEEL_EVENT.eventValues,function(i){t[i]=e[i]}),this.bridge.emit(a.wheelEvent,t))}singlePage(e){if(e===location.href)return!1;let t=!0;k()||(t=!1,this.domEditor.mode_type="VIEW"),this.bridge.emit(a.checkUrl,{status:t?"SUCCESS":"ERROR"})}mutationObserver(){let e=this;m.each(e.domEditor.serverData,function(t){let i=e.domEditor.getOriginDataBySelector(t.selector);i.ele&&e.domEditor.editEleProps(t,i)})}}class C{constructor(e){this.config=e.config,this.hoverDiv=null,this.selectDiv=null,this.maskDiv=null,this.mode_type="EDIT",this.serverData=[],this.originData=[],this.buildMarkDom()}setDomPostion(e,t){m.each(["width","height","left","top"],function(i){e.style[i]=t[i]+"px"}),e.style.zIndex=t.zIndex&&"auto"!==t.zIndex?Number(t.zIndex)+10:5e3}setHoverElePostion(e){this.selectDiv&&this.hoverDiv&&document.getElementById("sa-vabtest-mark")||this.buildMarkDom(),this.setDomPostion(this.hoverDiv,e)}setSelectElePostion(e){this.selectDiv&&this.hoverDiv||this.buildMarkDom(),this.setDomPostion(this.selectDiv,e)}restoreElements(){m.each(this.originData,function(e){T(e)}),this.originData=[],O({attr_key:"sensors_ab_style_id"}),O({attr_key:"sensors_ab_script_id"})}editEleProps(e,t){let i=t.eleInfo;_(t.ele,e,i)}setMode(e){var t;this.mode_type=e,"VIEW"===e&&((t=this.maskDiv)&&t.parentNode.removeChild(t),this.hoverDiv=null,this.selectDiv=null,this.maskDiv=null)}resetMarkDom(e){e&&this.setDomPostion(e,{width:0,height:0,top:0,left:0})}resetSelectDivPostion(){this.selectDiv&&this.hoverDiv||this.buildMarkDom(),this.setDomPostion(this.selectDiv,{width:0,height:0,top:0,left:0})}resetHoverDivPostion(){this.selectDiv&&this.hoverDiv||this.buildMarkDom(),this.setDomPostion(this.hoverDiv,{width:0,height:0,top:0,left:0})}buildMarkDom(){var e=document.createElement("div"),t=document.createElement("div"),i=document.createElement("div"),n=document.createElement("style");e.className="sa-vabtest-mark",e.id="sa-vabtest-mark",t.className="sa-vabtest-hover",i.className="sa-vabtest-clickable";var s=e.attachShadow({mode:"open"});n.innerText=".sa-vabtest-clickable { background: rgba(49, 112, 235, 0.15) !important; outline: 2px solid #3170EB !important; outline-offset: -2px !important; width: 0;height: 0;position: absolute; top: 0; left: 0;}.sa-vabtest-hover { outline: 2px solid #3170EB !important; outline-offset: -2px !important;  width: 0;height: 0;position: absolute; top: 0; left: 0;}",s.appendChild(n),s.appendChild(t),s.appendChild(i),document.body.appendChild(e),m.setCssStyle(".sa-vabtest-mark { pointer-events: none;}.sa-vabtest-mark-hidden { display: none;}"),this.hoverDiv=t,this.selectDiv=i,this.maskDiv=e}saveServerData(e){this.serverData=e}updataServerData(e,t){let i=!1,n=this;m.each(this.serverData,function(s,o){s.selector===e&&(n.serverData[o]=t,i=!0)}),i||this.serverData.push(t)}getServerDataBySelector(e){let t=null;return m.each(this.serverData,function(i){i.selector===e&&(t=i)}),t}setOriginData(e,t){let i=!1,n=this;m.each(this.originData,function(t,s){e===t.selector&&(n.originData[s]=t,i=!0)}),i||this.originData.push(t)}getOriginDataBySelector(e){let t=null;if(m.each(this.originData,function(i){e===i.eleInfo.selector&&(t=i)}),!t){let i=m.getDomBySelector(e);i?(t=N(i,this.config.styles),this.setOriginData(t.eleInfo.selector,t)):t={}}return t}getOriginDataByElement(e){let t=null;return m.each(this.originData,function(i){e===i.ele&&(t=i)}),t||(t=N(e,this.config.styles)),t}}class A{constructor(){this.plugin_name="VABTest",this.plugin_version="1.26.4",this.abTestingSDK=null,this.bridge=new h({source:"sa-web-abtesting-sdk",frameSource:"sa-fe-abtesting-mode",version:"abtest_version"})}init(e,t){this.abTestingSDK=t.SensorsABTest;let i=this;if(e&&this.abTestingSDK){!function(e){e._.extend(m,e._)}(e),this.bridge.emit(a.connect,{status:!0,lib_version:1}).then(function(t){if("SUCCESS"===t.status){let n=t.payload.support;i.domEditor=new C({config:n}),i.sender=new M({bridge:i.bridge,domEditor:i.domEditor,tagNames:n.tagNames,sd:e}),new P({bridge:i.bridge,domEditor:i.domEditor}),i.sender.init(n)}else m.log("ABTesting SDK \u53ef\u89c6\u5316\u7f16\u8f91\u72b6\u6001\u521d\u59cb\u5316\u5931\u8d25")})}else m.log("ABTesting SDK \u53ef\u89c6\u5316\u7f16\u8f91\u72b6\u6001\u521d\u59cb\u5316\u5931\u8d25")}}let H=new A;H.__constructor__=A,window.SensorsDataWebJSSDKPlugin&&"[object Object]"===Object.prototype.toString.call(window.SensorsDataWebJSSDKPlugin)?window.SensorsDataWebJSSDKPlugin.VABTest=window.SensorsDataWebJSSDKPlugin.VABTest||H:window.SensorsDataWebJSSDKPlugin={VABTest:H}});